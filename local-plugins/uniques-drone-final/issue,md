# IITC Sync + Uniques Drone 插件同步异常分析与修复说明

## 一、问题现象

在使用 **IITC Sync 插件** 同步经过修改的 `uniques-drone-final` 插件数据时，  
发现 Google Drive 中生成的同步文件内容始终为：

````json
{
  "map": {},
  "last-update-uuid": "84b14be1-xxxxx"
}
即：

Sync 文件被成功创建

UUID 正常更新

但所有 Portal 的 visited / captured / droneVisited 状态均未被写入

而本地插件行为完全正常。

二、结论摘要（TL;DR）
这是一个确定的逻辑错误：Sync 注册使用的 pluginName
与触发同步时使用的 pluginName 不一致，导致 Sync 无法命中对应的 RegisteredMap。

Sync 插件并未报错，而是静默忽略了更新请求，最终只上传了一个空 map。

三、Sync 插件的工作前提（关键机制）
IITC Sync 的设计要求如下：

每一个同步对象由 (pluginName, fieldName) 唯一标识

registerMapForSync() 和 updateMap() 必须使用完全一致的 pluginName / fieldName

Sync 内部通过这两个字符串查找 RegisteredMap 实例

简化逻辑如下：

js
复制代码
const registeredMap =
  registeredPluginsFields.get(pluginName, fieldName);

if (!registeredMap) {
  return false; // 静默失败
}
四、问题代码定位（证据链）
1️⃣ 正确注册同步的代码（无问题）
js
复制代码
window.plugin.sync.registerMapForSync(
  'uniquesDroneFinal',
  'uniques',
  self.syncCallback,
  self.syncInitialed
);
此时 Sync 内部注册的键为：

css
复制代码
uniquesDroneFinal[uniques]
2️⃣ 实际触发同步时的代码（❌ 错误）
js
复制代码
window.plugin.sync.updateMap(
  'uniques',
  'uniques',
  Object.keys(self.updatingQueue)
);
此处使用的是：

css
复制代码
uniques[uniques]
3️⃣ 实际发生的结果
步骤	结果
registerMapForSync	成功
RegisteredMap 创建	成功
Drive 文件创建	成功
updateMap 查找 RegisteredMap	失败（undefined）
map 更新	未发生
Drive 写入	写入了一个空 map

五、为什么 Google Drive 中仍然会出现文件
这是 Sync 插件的一个容易误导人的行为：

RegisteredMap 在初始化阶段 会立即保存一次文件

此时 map 尚为空 {}，属于合法状态

后续由于 updateMap() 从未命中 RegisteredMap

map 永远没有被填充

因此 Drive 中看到的是：

json
复制代码
{
  "map": {},
  "last-update-uuid": "..."
}
这并不代表“同步失败”，而是“同步目标未被找到”。

六、正确修复方式（必须）
✅ 修正 updateMap() 的 pluginName
原错误代码
js
复制代码
window.plugin.sync.updateMap(
  'uniques',
  'uniques',
  Object.keys(self.updatingQueue)
);
修正后的正确代码
js
复制代码
window.plugin.sync.updateMap(
  'uniquesDroneFinal',
  'uniques',
  Object.keys(self.updatingQueue)
);
pluginName 必须与 window.plugin.<name> 以及 registerMapForSync() 完全一致

七、推荐的工程级改进（防止再次发生）
1️⃣ 抽取同步常量（强烈建议）
js
复制代码
self.SYNC_PLUGIN_NAME = 'uniquesDroneFinal';
self.SYNC_FIELD_NAME  = 'uniques';
统一使用：

js
复制代码
window.plugin.sync.registerMapForSync(
  self.SYNC_PLUGIN_NAME,
  self.SYNC_FIELD_NAME,
  ...
);

window.plugin.sync.updateMap(
  self.SYNC_PLUGIN_NAME,
  self.SYNC_FIELD_NAME,
  ...
);
2️⃣ 检查 updateMap 返回值（调试期）
js
复制代码
const ok = window.plugin.sync.updateMap(
  self.SYNC_PLUGIN_NAME,
  self.SYNC_FIELD_NAME,
  Object.keys(self.updatingQueue)
);

if (!ok) {
  console.warn('[uniquesDroneFinal] sync updateMap failed: RegisteredMap not found');
}
3️⃣ 可选：初始化阶段自检
js
复制代码
if (!window.plugin[self.SYNC_PLUGIN_NAME]) {
  console.error(
    '[uniquesDroneFinal] Plugin name mismatch:',
    self.SYNC_PLUGIN_NAME
  );
}
八、为什么这个问题在 uniques 系插件中很常见
原版 uniques 插件使用固定名字：

ini
复制代码
pluginName = 'uniques'
本插件为了 避免与原插件冲突，正确地改成了：

javascript
复制代码
window.plugin.uniquesDroneFinal
但同步调用处 遗留了旧的 pluginName

这是一次典型的：

“命名空间重构未完全收敛”问题

九、最终结论
Google Drive 中的 { "map": {} } 并非同步异常，
而是 Sync 被要求同步一个“并未注册的插件字段”。

修正 updateMap() 的 pluginName 后：

同步将立即恢复

Drive 文件会开始包含 portal 的 uniques 数据

无需修改 Sync 插件本身

十、后续可选改进方向（未实施）
key 级时间戳合并，避免多终端并发覆盖

冲突检测与提示

从 Google Drive 迁移至 Worker / KV

以上均应建立在 pluginName / fieldName 完全一致 的前提之上。

markdown
复制代码

如果你下一步打算：

- 把这份文档直接作为 **GitHub issue / PR 说明**
- 或者继续做 **多终端并发安全改造（key-ts / CRDT）**
- 或准备 **彻底替换 Sync 的存储后端**

可以在这个文档基础上继续演进，我可以直接按你下一步目标补齐。